<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat da Galera</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Helvetica, Arial, sans-serif; padding: 20px; background-color: #f0f2f5; }
        #chat-box { 
            height: 60vh; 
            background: white; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow-y: scroll; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; background-color: #e9ecef; }
        .msg strong { color: #2c3e50; }
        
        .controles { display: flex; gap: 5px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #nome { width: 30%; }
        #msg { flex-grow: 1; }
        button { padding: 10px 20px; background-color: #24b47e; color: white; border: none; border-radius: 4px; font-weight: bold; }
        
        /* Caixa de erro para diagnÃ³stico */
        #aviso-erro { color: red; background: #ffe6e6; padding: 10px; display: none; margin-bottom: 10px; border: 1px solid red; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">ðŸ’¬ Chat Ao Vivo</h2>
    
    <!-- Se der erro, vai aparecer aqui -->
    <div id="aviso-erro"></div>

    <div id="chat-box">Carregando histÃ³rico...</div>

    <div class="controles">
        <input type="text" id="nome" placeholder="Seu apelido">
        <input type="text" id="msg" placeholder="Digite algo...">
        <button onclick="enviar()">Enviar</button>
    </div>

    <script>
        // --- SUAS CHAVES DO SUPABASE ---
        const supabaseUrl = 'https://zwszvrmbciryfveaddbh.supabase.co';
        // ATENÃ‡ÃƒO: Esta chave deve ficar TUDO NA MESMA LINHA:
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3c3p2cm1iY2lyeWZ2ZWFkZGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDE1MTEsImV4cCI6MjA3OTg3NzUxMX0.8LZ1bNRw7_hxKg714qzkTjoht3u51MMlgRrM6sd4BCs';

        // Inicia o cliente
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const chatBox = document.getElementById('chat-box');
        const avisoErro = document.getElementById('aviso-erro');

        // FunÃ§Ã£o para mostrar erro na tela (ajuda a descobrir o problema)
        function mostrarErro(texto) {
            avisoErro.style.display = 'block';
            avisoErro.innerText = 'ERRO: ' + texto;
            chatBox.innerHTML = 'ðŸ”´ O sistema parou.';
        }

        // 1. Carregar mensagens
        async function carregar() {
            const { data, error } = await supabase
                .from('mensagens')
                .select('*')
                .order('id', {ascending: true}); // Ordena por ID ou created_at

            if (error) {
                mostrarErro(error.message);
            } else {
                chatBox.innerHTML = ''; // Limpa o "Carregando..."
                data.forEach(m => adicionarNaTela(m));
                rolarParaBaixo();
            }
        }

        // 2. Adicionar mensagem visualmente
        function adicionarNaTela(mensagem) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<strong>${mensagem.usuario}:</strong> ${mensagem.texto}`;
            chatBox.appendChild(div);
            rolarParaBaixo();
        }

        // 3. Enviar mensagem
        async function enviar() {
            const nomeInput = document.getElementById('nome');
            const msgInput = document.getElementById('msg');
            
            const usuario = nomeInput.value;
            const texto = msgInput.value;

            if (!usuario || !texto) return alert("Preencha nome e mensagem!");

            const { error } = await supabase
                .from('mensagens')
                .insert([{ usuario: usuario, texto: texto }]);

            if (error) {
                mostrarErro("Falha ao enviar: " + error.message);
            } else {
                msgInput.value = ''; // Limpa o campo
            }
        }

        function rolarParaBaixo() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 4. Tempo Real (Ouvir novas mensagens)
        supabase.channel('canal-publico')
            .on(
                'postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'mensagens' }, 
                (payload) => {
                    adicionarNaTela(payload.new);
                }
            )
            .subscribe();

        // Inicia o carregamento
        carregar();

    </script>
</body>
</html>
