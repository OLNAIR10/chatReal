<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Ao Vivo</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        #chat-box { 
            height: 60vh; background: white; border: 1px solid #ccc; 
            border-radius: 8px; overflow-y: scroll; padding: 15px; 
            margin-bottom: 15px; 
        }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; background-color: #e9ecef; }
        input { padding: 10px; border: 1px solid #ccc; width: 60%; }
        button { padding: 10px; background-color: #24b47e; color: white; border: none; font-weight: bold; }
        #aviso-erro { color: red; background: #ffe6e6; padding: 10px; display: none; border: 1px solid red; margin-bottom: 10px;}
    </style>
</head>
<body>

    <h2 style="text-align: center;">ðŸ’¬ Chat Ao Vivo</h2>
    
    <div id="aviso-erro"></div>
    <div id="chat-box">Carregando...</div>

    <div>
        <input type="text" id="nome" placeholder="Seu Nome" style="width: 25%;">
        <input type="text" id="msg" placeholder="Mensagem..." style="width: 45%;">
        <button onclick="enviar()">Enviar</button>
    </div>

    <script>
        // --- CHAVES ATUALIZADAS (Novas Chaves Inseridas Aqui) ---
        const parte1 = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhubWhnbHpidXJyY3R4Znh2aWRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDM5NTgsImV4cCI6MjA3OTg3OTk1OH0.';
        const parte2 = 'NLpwzO2aJfWjyBPe9Nap5OmBfd-a00F9EGrDbEKru_A';
        
        const supabaseUrl = 'https://xnmhglzburrctxfxvids.supabase.co';
        const supabaseKey = parte1 + parte2; // Junta as partes aqui

        // Inicia o sistema
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const chatBox = document.getElementById('chat-box');
        const avisoErro = document.getElementById('aviso-erro');
        const btnEnviar = document.querySelector('button');

        // FunÃ§Ã£o de Erro
        function mostrarErro(txt) {
            avisoErro.style.display = 'block';
            avisoErro.innerText = 'ERRO: ' + txt;
            chatBox.innerHTML = 'ðŸ”´ Parou.';
        }

        // 1. Carregar
        async function carregar() {
            try {
                const { data, error } = await supabase
                    .from('mensagens')
                    .select('*')
                    .order('id', {ascending: true});

                if (error) throw error;

                chatBox.innerHTML = ''; 
                data.forEach(m => addMsg(m));
                rolar();
            } catch (err) {
                mostrarErro(err.message);
            }
        }

        // 2. Mostrar na tela (Melhoria: PrevenÃ§Ã£o de XSS e Performance do DOM)
        function addMsg(msg) {
            // Cria o elemento principal da mensagem
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('msg');

            // Cria o strong para o nome do usuÃ¡rio
            const strong = document.createElement('strong');
            // USA .textContent para seguranÃ§a XSS no nome do usuÃ¡rio
            strong.textContent = msg.usuario + ': '; 
            
            // Cria um nÃ³ de texto puro para o conteÃºdo da mensagem (SeguranÃ§a XSS)
            const textNode = document.createTextNode(msg.texto);

            // Monta o div e adiciona ao chat
            msgDiv.appendChild(strong);
            msgDiv.appendChild(textNode);
            
            chatBox.appendChild(msgDiv); // Adiciona de forma eficiente (melhor que innerHTML +=)
            rolar();
        }

        // 3. Enviar (Melhoria: .trim() para limpeza e controle de botÃ£o)
        async function enviar() {
            const usuario = document.getElementById('nome').value.trim(); // .trim() para limpar espaÃ§os
            const texto = document.getElementById('msg').value.trim(); // .trim() para limpar espaÃ§os

            if (!usuario || !texto) return alert("Preencha tudo!");

            btnEnviar.disabled = true; // Desabilita o botÃ£o para evitar clique duplo
            btnEnviar.innerText = 'Enviando...';

            const { error } = await supabase
                .from('mensagens')
                .insert([{ usuario, texto }]);

            btnEnviar.disabled = false; // Habilita o botÃ£o
            btnEnviar.innerText = 'Enviar';

            if (error) mostrarErro(error.message);
            else document.getElementById('msg').value = '';
        }

        // Rola para o fim (Melhoria: Opcional, pode usar 'smooth' para rolagem mais suave)
        function rolar() { 
            chatBox.scrollTo({ 
                top: chatBox.scrollHeight, 
                behavior: 'smooth' 
            });
        }

        // 4. Tempo Real
        supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensagens' }, (payload) => {
                addMsg(payload.new);
            })
            .subscribe();

        // 5. UX: Enviar com a tecla Enter
        document.getElementById('msg').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                enviar();
            }
        });

        carregar();
    </script>
</body>
</html>
