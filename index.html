<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Ao Vivo</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        #chat-box { 
            height: 60vh; background: white; border: 1px solid #ccc; 
            border-radius: 8px; overflow-y: scroll; padding: 15px; 
            margin-bottom: 15px; 
        }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; background-color: #e9ecef; }
        input { padding: 10px; border: 1px solid #ccc; width: 60%; }
        button { padding: 10px; background-color: #24b47e; color: white; border: none; font-weight: bold; }
        #aviso-erro { color: red; background: #ffe6e6; padding: 10px; display: none; border: 1px solid red; margin-bottom: 10px;}
    </style>
</head>
<body>

    <h2 style="text-align: center;">ðŸ’¬ Chat Ao Vivo</h2>
    
    <div id="aviso-erro"></div>
    <div id="chat-box">Carregando...</div>

    <div>
        <input type="text" id="nome" placeholder="Seu Nome" style="width: 25%;">
        <input type="text" id="msg" placeholder="Mensagem..." style="width: 45%;">
        <button onclick="enviar()">Enviar</button>
    </div>

    <script>
        // --- TRUQUE PARA NÃƒO QUEBRAR NO CELULAR ---
        // Dividi a chave em 2 partes para nÃ£o dar erro de quebra de linha
        const parte1 = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3c3p2cm1iY2lyeWZ2ZWFkZGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDE1MTEsImV4cCI6MjA3OTg3NzUxMX0.';
        const parte2 = '8LZ1bNRw7_hxKg714qzkTjoht3u51MMlgRrM6sd4BCs';
        
        const supabaseUrl = 'https://zwszvrmbciryfveaddbh.supabase.co';
        const supabaseKey = parte1 + parte2; // Junta as partes aqui

        // Inicia o sistema
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const chatBox = document.getElementById('chat-box');
        const avisoErro = document.getElementById('aviso-erro');

        // FunÃ§Ã£o de Erro
        function mostrarErro(txt) {
            avisoErro.style.display = 'block';
            avisoErro.innerText = 'ERRO: ' + txt;
            chatBox.innerHTML = 'ðŸ”´ Parou.';
        }

        // 1. Carregar
        async function carregar() {
            try {
                const { data, error } = await supabase
                    .from('mensagens')
                    .select('*')
                    .order('id', {ascending: true});

                if (error) throw error;

                chatBox.innerHTML = ''; 
                data.forEach(m => addMsg(m));
                rolar();
            } catch (err) {
                mostrarErro(err.message);
            }
        }

        // 2. Mostrar na tela
        function addMsg(msg) {
            chatBox.innerHTML += `<div class="msg"><strong>${msg.usuario}:</strong> ${msg.texto}</div>`;
            rolar();
        }

        // 3. Enviar
        async function enviar() {
            const usuario = document.getElementById('nome').value;
            const texto = document.getElementById('msg').value;

            if (!usuario || !texto) return alert("Preencha tudo!");

            const { error } = await supabase
                .from('mensagens')
                .insert([{ usuario, texto }]);

            if (error) mostrarErro(error.message);
            else document.getElementById('msg').value = '';
        }

        function rolar() { chatBox.scrollTop = chatBox.scrollHeight; }

        // 4. Tempo Real
        supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensagens' }, (payload) => {
                addMsg(payload.new);
            })
            .subscribe();

        carregar();
    </script>
</body>
</html>
